<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Georgia Tax Sale Listings</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker immediately after loading
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <!-- Leaflet CSS and JS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        .search-section {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group select,
        .form-group input {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            min-width: 140px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
            transform: translateY(-3px);
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .stat-item {
            color: white;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Progress Section */
        .progress-section {
            background: rgba(255, 255, 255, 0.98);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border: 2px solid rgba(102, 126, 234, 0.3);
            display: none;
            position: relative;
            z-index: 10;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-section.show {
            display: block;
        }

        .progress-container {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 1rem;
            padding: 2rem;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: inset 0 2px 10px rgba(102, 126, 234, 0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
        }

        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 16px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
            position: relative;
            animation: gradientShift 2s infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-details {
            font-size: 0.9rem;
            color: #667eea;
        }

        /* Table Section */
        .table-section {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 30px;
        }

        .table-section h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 2rem;
            font-weight: 600;
        }

        .table-container {
            position: relative;
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .table-controls {
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .listing-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .listing-table th,
        .listing-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .listing-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .listing-table th[onclick] {
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            transition: all 0.2s ease;
        }

        .listing-table th[onclick]:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
            transform: translateY(-1px);
        }

        .listing-table tr:nth-child(even) {
            background: rgba(102, 126, 234, 0.05);
        }

        .listing-table tr:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .listing-table td {
            font-size: 0.9rem;
            color: #555;
        }

        .amount-cell {
            font-weight: 600;
            color: #667eea;
        }

        .location-cell {
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
            border-radius: 8px;
        }

        /* Map Section */
        .map-section {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .map-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .map-container {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }

            .table-container {
                font-size: 0.8rem;
            }

            .listing-table th,
            .listing-table td {
                padding: 8px 12px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Floating Action Button */
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: none;
        }

        .floating-action:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        /* Modal Styles */
        .street-view-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .street-view-content {
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 600px;
            max-height: 90vh;
            width: 100%;
            overflow: auto;
            position: relative;
            box-sizing: border-box;
        }

        /* Property Modal Specific Styles */
        .property-modal-header {
            margin: 0 0 20px 0;
            color: #667eea;
            display: flex;
            align-items: center;
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            justify-content: center;
        }

        .property-info-card {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 0;
        }

        .property-street-view {
            margin-bottom: 25px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .property-street-view iframe {
            width: 100%;
            height: 350px;
            border: none;
            border-radius: 12px;
        }

        .property-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 0;
        }

        .property-detail-item {
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .property-detail-label {
            color: #64748b;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .property-detail-value {
            color: #475569;
            font-size: 1.1rem;
        }

        .property-amount {
            font-size: 1.3em;
            color: #dc2626;
            font-weight: bold;
        }

        .property-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .property-detail-item {
            display: flex;
            flex-direction: column;
        }

        .property-detail-label {
            color: #64748b;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .property-detail-value {
            color: #475569;
        }

        .property-amount {
            font-size: 1.1em;
            color: #dc2626;
            font-weight: bold;
        }

        .property-coordinates {
            color: #475569;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .property-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .property-action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-decoration: none;
            min-height: 44px;
            box-sizing: border-box;
        }

        .property-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .property-action-btn:active {
            transform: translateY(0);
        }

        .property-action-btn.street-view {
            background: #f093fb;
        }

        .property-action-btn.street-view:hover {
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
        }

        .property-action-btn.copy {
            background: #059669;
        }

        .property-action-btn.copy:hover {
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .property-action-btn.copied {
            background: #16a34a !important;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .street-view-modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            .street-view-content {
                max-height: 95vh;
                border-radius: 15px;
                padding: 15px;
                margin-top: 0;
            }

            .property-modal-header {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            .property-street-view iframe {
                height: 250px;
            }

            .property-street-view-loading {
                height: 250px;
                font-size: 1rem;
            }

            .property-info-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .property-address {
                font-size: 1.1em;
                margin-bottom: 12px;
            }

            .property-details-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 12px;
            }

            .property-actions {
                flex-direction: column;
                gap: 8px;
            }

            .property-action-btn {
                width: 100%;
                justify-content: center;
                padding: 14px 16px;
                font-size: 1rem;
            }

            .modal-close {
                font-size: 1.8rem;
                top: 10px;
                right: 15px;
                padding: 5px;
                min-width: 40px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Progress Bar Styles */
        .progress-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(420px);
            transition: transform 0.3s ease-in-out;
        }

        .progress-container.show {
            transform: translateX(0);
        }

        .progress-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #334155;
        }

        .progress-icon {
            margin-right: 10px;
            font-size: 1.2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #64748b;
            text-align: center;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Mobile Progress Bar */
        @media (max-width: 768px) {
            .progress-container {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
                max-width: none;
                transform: translateY(-120px);
            }

            .progress-container.show {
                transform: translateY(0);
            }
            
            .street-view-modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            .street-view-content {
                max-height: 95vh;
                border-radius: 15px;
                padding: 15px;
                margin-top: 0;
            }

            .property-modal-header {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            .property-street-view iframe {
                height: 250px;
            }

            .property-street-view-loading {
                height: 250px;
                font-size: 1rem;
            }

            .property-info-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .property-address {
                font-size: 1.1em;
                margin-bottom: 12px;
            }

            .property-details-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 12px;
            }

            .property-actions {
                flex-direction: column;
                gap: 8px;
            }

            .property-action-btn {
                width: 100%;
                justify-content: center;
                padding: 14px 16px;
                font-size: 1rem;
            }

            .modal-close {
                font-size: 1.8rem;
                top: 10px;
                right: 15px;
                padding: 5px;
                min-width: 40px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .street-view-modal {
                padding: 5px;
                padding-top: 10px;
            }

            .street-view-content {
                border-radius: 10px;
                padding: 12px;
                max-height: 98vh;
            }

            .property-modal-header {
                font-size: 1.2rem;
            }

            .property-street-view iframe {
                height: 200px;
            }

            .property-street-view-loading {
                height: 200px;
                font-size: 0.9rem;
            }

            .property-info-card {
                padding: 12px;
            }

            .property-address {
                font-size: 1rem;
            }

            .property-detail-label {
                font-size: 0.85rem;
            }

            .property-detail-value {
                font-size: 0.9rem;
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #667eea;
        }

        /* Loading Animation */
        .loading-animation {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status message styles */
        .status-message {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #065f46;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #991b1b;
        }

        .status-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Georgia Tax Sale Listings</h1>
            <p>Discover investment opportunities in Georgia's tax sale properties</p>
        </div>

        <div class="search-section">
            <div class="controls">
                <div class="form-group">
                    <label for="countySelect">üìç County</label>
                    <select id="countySelect">
                        <option value="">üîç Loading counties...</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="toggleMap()">
                    üìç Show Properties on Map
                </button>
                <button class="btn btn-outline" onclick="geocodeProperties()" class="hidden" id="geocodeBtn">
                    üîç Find Property Locations
                </button>
            </div>
            
            <div class="loading-animation" id="loading">
                <div class="spinner"></div>
                <p>Loading properties...</p>
            </div>
        </div>

        <div class="stats-section" id="statsContainer">
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="stat-total">0</span>
                    <span class="stat-label">Active Listings</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="stat-avg">$0</span>
                    <span class="stat-label">Average Amount</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="stat-counties">0</span>
                    <span class="stat-label">Counties</span>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="statusContainer">
        </div>

        <!-- Map Section -->
        <div class="map-section hidden" id="mapContainer">
            <div class="map-controls">
                <button id="showMapBtn" class="btn btn-primary" onclick="toggleMap()">üìç Hide Map</button>
                <button id="fitToPropertiesBtn" class="btn btn-outline" onclick="fitMapToProperties()">üéØ Fit to Properties</button>
            </div>
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="table-section" id="listingContainer">
        </div>
    </div>

    <button class="floating-action" onclick="scrollToTop()" title="Back to top">
        ‚Üë
    </button>

    <!-- Street View Modal -->
    <div id="streetViewModal" class="street-view-modal hidden">
        <div class="street-view-content">
            <button class="modal-close" onclick="closeStreetView()">&times;</button>
            <div id="streetViewContent"></div>
        </div>
    </div>

    <!-- Property Details Modal -->
    <div id="propertyModal" class="street-view-modal hidden">
        <div class="street-view-content">
            <button class="modal-close" onclick="closePropertyModal()">&times;</button>
            <div id="propertyModalContent"></div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div id="progressContainer" class="progress-container">
        <div class="progress-header">
            <span class="progress-icon">üó∫Ô∏è</span>
            <span id="progressTitle">Plotting Properties on Map</span>
        </div>
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" class="progress-text">Preparing...</div>
        <div class="progress-stats">
            <span id="progressCurrent">0</span>
            <span id="progressTotal">0</span>
        </div>
    </div>

    <script>
        let currentData = null;
        let map;
        let markers = [];
        let currentSort = 'address';


        // Get the base URL for API calls (works both locally and when deployed)
        const API_BASE = window.location.origin;

        // Initialize map
        function initializeMap() {
            if (!map) {
                map = L.map('map').setView([32.5, -83.5], 7); // Georgia center
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            }
        }

        // Update statistics display
        function updateStats(data) {
            console.log('updateStats called with:', data);
            if (!data || !data.parsedListings) {
                console.log('No data or parsedListings found');
                return;
            }
            
            const listings = data.parsedListings;
            const totalListings = listings.length;
            console.log('Processing', totalListings, 'listings');
            
            const amounts = listings.map(l => {
                const amount = l.taxAmount || l.bidAmount || l.amount || '0';
                return parseFloat(amount.toString().replace(/[$,]/g, '')) || 0;
            });
            const avgAmount = amounts.length > 0 ? amounts.reduce((a, b) => a + b, 0) / amounts.length : 0;
            console.log('Average amount calculated:', avgAmount);
            
            const totalElement = document.getElementById('stat-total');
            const avgElement = document.getElementById('stat-avg');
            const countiesElement = document.getElementById('stat-counties');
            
            console.log('Elements found:', {totalElement, avgElement, countiesElement});
            
            if (totalElement) totalElement.textContent = totalListings.toLocaleString();
            if (avgElement) avgElement.textContent = `$${Math.round(avgAmount).toLocaleString()}`;
            if (countiesElement) countiesElement.textContent = '2'; // Chatham and DeKalb
            
            console.log('Stats updated successfully');
        }

        // Debug function to test specific address geocoding
        window.debugGeocode = async function(address) {
            console.log('üîç Debug geocoding for:', address);
            const result = await tryGeocoding(address);
            if (result && result.length > 0) {
                console.log('üìç Results:', result.map(r => ({
                    lat: r.lat,
                    lon: r.lon,
                    display_name: r.display_name,
                    address: r.address
                })));
            } else {
                console.log('‚ùå No results found');
            }
            return result;
        };

        // Enhanced test function for checking server geocoding endpoint
        window.testServerGeocode = async function() {
            const testAddresses = [
                "7205 W SUGAR TREE CT",
                "102 REDAN DR", 
                "121 BOBSTAY CT",
                "26 MISTWOODE SUB 17 RUSTIC LN 31406, said property being formerly in the name of RELYEA",
                "105 MILLS RUN S/D PHASE 3 108 BLAINE CT 31405, said property being formerly in the",
                "88 KNIGHTSBRIDGE SUB PH 3 SMB 13S 3, 112 ST IVES DR, SAID"
            ];
            
            console.log('üß™ Testing server geocoding endpoint...');
            for (let addr of testAddresses) {
                console.log(`\n--- Testing: ${addr} ---`);
                
                try {
                    const response = await fetch(`${API_BASE}/api/geocode`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ address: addr })
                    });
                    
                    const data = await response.json();
                    console.log('Server response:', data);
                    
                    if (data.success && data.results && data.results.length > 0) {
                        const result = data.results[0];
                        console.log(`‚úÖ ${addr} -> ${result.lat}, ${result.lon}`);
                        console.log(`   Location: ${result.display_name}`);
                        console.log(`   Strategy: ${data.strategy}`);
                        console.log(`   Cached: ${data.cached}`);
                    } else {
                        console.log(`‚ùå ${addr} -> ${data.error || 'No results'}`);
                        if (data.cleanedAddress) {
                            console.log(`   Cleaned to: "${data.cleanedAddress}"`);
                        }
                    }
                } catch (error) {
                    console.log(`‚ùå ${addr} -> Error: ${error.message}`);
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        };
        
        // Test just the address cleaning without geocoding
        window.testAddressCleaning = async function() {
            const testAddresses = [
                "26 MISTWOODE SUB 17 RUSTIC LN 31406, said property being formerly in the name of RELYEA",
                "105 MILLS RUN S/D PHASE 3 108 BLAINE CT 31405, said property being formerly in the",
                "88 KNIGHTSBRIDGE SUB PH 3 SMB 13S 3, 112 ST IVES DR, SAID",
                "147 S ROBIN HOOD DR, said property",
                "LOT 26 MISTWOODE SUB 17 RUSTIC LN 31406",
                "123 MAIN ST 31404, SAID PROPERTY BEING FORMERLY",
                "456 OAK AVE 31419 said property being in the name of SMITH"
            ];
            
            console.log('üß™ Testing address cleaning with zip code handling...');
            for (let addr of testAddresses) {
                console.log(`\n--- Cleaning: ${addr} ---`);
                
                try {
                    const response = await fetch(`${API_BASE}/api/test-clean-address`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ address: addr })
                    });
                    
                    const data = await response.json();
                    console.log(`Original: "${addr}"`);
                    console.log(`Cleaned:  "${data.cleaned}"`);
                    console.log(`Valid:    ${data.isValid}`);
                    console.log(`Extracted Zip: ${data.extractedZipCode || 'None'}`);
                    
                    // Extract zip code from original to verify it's preserved in parsing
                    const originalZip = addr.match(/\b(\d{5})\b/);
                    if (originalZip) {
                        console.log(`Zip found in original: ${originalZip[1]}`);
                        if (data.extractedZipCode === originalZip[1]) {
                            console.log(`‚úÖ Zip code extraction successful!`);
                        } else {
                            console.log(`‚ùå Zip code extraction failed - expected ${originalZip[1]}, got ${data.extractedZipCode}`);
                        }
                    }
                } catch (error) {
                    console.log(`‚ùå Error: ${error.message}`);
                }
            }
        };

        // County coordinates for reference
        const COUNTY_COORDINATES = {
            chatham: { lat: 32.0835, lng: -81.0998, name: 'Chatham County (Savannah)' },
            dekalb: { lat: 33.7490, lng: -84.3880, name: 'DeKalb County (Atlanta)' }
        };

        // Default county setting - change this to set your preferred default
        const DEFAULT_COUNTY = 'chatham'; // Options: 'chatham' or 'dekalb'

        // Load available counties and set up auto-selection
        async function loadCounties() {
            try {
                console.log('üèòÔ∏è Loading counties from API...');
                const response = await fetch(`${API_BASE}/api/counties`);
                const countiesData = await response.json();
                console.log('üèòÔ∏è Counties data received:', countiesData);
                
                const countySelect = document.getElementById('countySelect');
                countySelect.innerHTML = '';
                
                // Add counties to dropdown
                countiesData.forEach(countyData => {
                    const option = document.createElement('option');
                    option.value = countyData.id; // Use the 'id' field from the API response
                    option.textContent = COUNTY_COORDINATES[countyData.id] ? 
                        COUNTY_COORDINATES[countyData.id].name : 
                        countyData.name; // Use 'name' field from API response as fallback
                    countySelect.appendChild(option);
                    console.log(`üèòÔ∏è Added county option: ${option.value} - ${option.textContent}`);
                });

                // Set default county selection
                const defaultCounty = DEFAULT_COUNTY;
                countySelect.value = defaultCounty;
                
                // Update the label to show the default county
                const countyLabel = document.querySelector('label[for="countySelect"]');
                const defaultCountyName = COUNTY_COORDINATES[defaultCounty] ? 
                    COUNTY_COORDINATES[defaultCounty].name : 
                    defaultCounty.charAt(0).toUpperCase() + defaultCounty.slice(1) + ' County';
                
                countyLabel.innerHTML = `üìç County <small style="color: #667eea; font-weight: normal;">(${defaultCountyName} default)</small>`;
                
                // Add change event listener for county selection
                countySelect.addEventListener('change', function() {
                    // Update label when user manually changes county
                    const selectedCountyName = COUNTY_COORDINATES[this.value] ? 
                        COUNTY_COORDINATES[this.value].name : 
                        this.value.charAt(0).toUpperCase() + this.value.slice(1) + ' County';
                    countyLabel.innerHTML = `üìç County <small style="color: #888; font-weight: normal;">(${selectedCountyName} selected)</small>`;
                    loadListings();
                });
                
                // Auto-load listings for the default county
                await loadListings();
                
            } catch (error) {
                console.error('Error loading counties:', error);
                console.log('üèòÔ∏è Falling back to manual county options...');
                
                // Fallback: manually add county options
                const countySelect = document.getElementById('countySelect');
                countySelect.innerHTML = '';
                
                // Add hardcoded county options
                Object.keys(COUNTY_COORDINATES).forEach(countyId => {
                    const option = document.createElement('option');
                    option.value = countyId;
                    option.textContent = COUNTY_COORDINATES[countyId].name;
                    countySelect.appendChild(option);
                    console.log(`üèòÔ∏è Added fallback county option: ${option.value} - ${option.textContent}`);
                });
                
                // Set default county selection (fallback)
                const defaultCounty = DEFAULT_COUNTY;
                countySelect.value = defaultCounty;
                
                // Update the label to show which county was set as default
                const countyLabel = document.querySelector('label[for="countySelect"]');
                const defaultCountyName = COUNTY_COORDINATES[defaultCounty].name;
                countyLabel.innerHTML = `üìç County <small style="color: #667eea; font-weight: normal;">(${defaultCountyName} default)</small>`;
                
                // Add change event listener for county selection
                countySelect.addEventListener('change', function() {
                    const selectedCountyName = COUNTY_COORDINATES[this.value].name;
                    countyLabel.innerHTML = `üìç County <small style="color: #888; font-weight: normal;">(${selectedCountyName} selected)</small>`;
                    loadListings();
                });
                
                // Auto-load listings for the default county
                await loadListings();
            }
        }

        // Update progress bar
        function updateProgress(percentage, message) {
            const progressFill = document.getElementById('progress-fill');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressDetails = document.getElementById('progress-details');
            
            if (progressFill) {
                progressFill.style.width = percentage + '%';
            }
            if (progressPercentage) {
                progressPercentage.textContent = percentage + '%';
            }
            if (progressDetails) {
                progressDetails.textContent = message;
            }
        }

        // Load property listings
        async function loadListings() {
            console.log('Load Listings button clicked!');
            const statusContainer = document.getElementById('statusContainer');
            const listingContainer = document.getElementById('listingContainer');
            const loadingAnimation = document.getElementById('loading');
            
            console.log('Elements found:', { statusContainer, listingContainer, loadingAnimation });
            
            // Show loading state
            if (loadingAnimation) {
                loadingAnimation.style.display = 'block';
            }
            statusContainer.innerHTML = '';
            listingContainer.innerHTML = '';
            
            try {
                const selectedCounty = document.getElementById('countySelect').value;
                const url = `${API_BASE}/api/tax-sale-listings/${selectedCounty}`;
                console.log('Fetching from URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Show progress section
                statusContainer.innerHTML = `
                    <div class="progress-container">
                        <div class="progress-header">
                            <div class="progress-title">Processing Tax Sale Data...</div>
                            <div class="progress-percentage" id="progress-percentage">0%</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-details" id="progress-details">
                            Connecting to server...
                        </div>
                    </div>
                `;
                // Ensure progress section is fully visible
                statusContainer.classList.remove('progress-section', 'show');
                statusContainer.style.display = 'block';
                statusContainer.classList.add('progress-section', 'show');
                
                // Simulate realistic loading progress
                updateProgress(10, 'Connecting to server...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                updateProgress(25, 'Fetching tax sale data...');
                await new Promise(resolve => setTimeout(resolve, 400));
                
                updateProgress(45, 'Processing property records...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(65, 'Loading data from server...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Parse the complete JSON response
                const data = await response.json();
                console.log('Received data:', data);
                console.log('Data type:', typeof data);
                console.log('Parsed listings:', data.parsedListings ? data.parsedListings.length : 'No parsedListings found');
                
                updateProgress(85, 'Validating address data...');
                await new Promise(resolve => setTimeout(resolve, 400));
                
                updateProgress(95, 'Preparing property display...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Process the data
                currentData = data;
                
                // Show geocoding info if available
                const geocodeMsg = data.geocodeStats ? 
                    `Complete! Found ${data.parsedListings ? data.parsedListings.length : 0} properties (${data.geocodeStats.successful}/${data.geocodeStats.total} geocoded)` :
                    `Complete! Found ${data.parsedListings ? data.parsedListings.length : 0} properties`;
                
                updateProgress(100, geocodeMsg);
                await new Promise(resolve => setTimeout(resolve, 1500)); // Show completion longer
                
                // Hide progress bar completely
                statusContainer.classList.remove('progress-section', 'show');
                statusContainer.style.display = 'none';
                
                // Hide loading animation
                if (loadingAnimation) {
                    loadingAnimation.style.display = 'none';
                }
                
                // Show results
                console.log('Calling displayResults...');
                displayResults(data);
                console.log('Calling updateStats...');
                updateStats(data);
                
                // Auto-show map with properties if we have addresses
                const hasAddresses = data.parsedListings && 
                    data.parsedListings.some(listing => listing.address);
                
                if (hasAddresses) {
                    // Ensure map is visible
                    const mapContainer = document.getElementById('mapContainer');
                    if (mapContainer.style.display === 'none' || !mapContainer.classList.contains('visible')) {
                        toggleMap();
                    }
                    // Show properties on map using addresses
                    await showPropertiesOnMap(data.parsedListings);
                }
                
                // Show map controls
                document.getElementById('geocodeBtn').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading listings:', error);
                if (loadingAnimation) {
                    loadingAnimation.style.display = 'none';
                }
                statusContainer.innerHTML = `
                    <div class="status-message status-error">
                        Failed to load property listings. Please try again. Error: ${error.message}
                    </div>
                `;
            }
        }

        // Display results in table format
        function displayResults(data) {
            console.log('displayResults called with:', data);
            const container = document.getElementById('listingContainer');
            console.log('Container element:', container);
            
            let statusHTML = `
                <h2>üìã ${data.county ? data.county.charAt(0).toUpperCase() + data.county.slice(1) : ''} County Tax Sale Properties</h2>
                <div class="status-message status-success">
                    <strong>‚úÖ ${data.totalListings} properties loaded successfully</strong><br>
            `;
            
            // Add metadata info
            if (data.fromCache) {
                statusHTML += `üíæ Data source: Database cache (instant loading)<br>`;
            } else if (data.metadata && data.metadata.databaseStored) {
                statusHTML += `üíæ Data cached to database for future use<br>`;
            }
            
            if (data.metadata) {
                if (data.metadata.taxSaleDate) {
                    statusHTML += `üìÖ Tax Sale Date: ${data.metadata.taxSaleDate}<br>`;
                }

                if (data.geocodeStats) {
                    statusHTML += `üó∫Ô∏è ${data.geocodeStats.successful}/${data.geocodeStats.total} properties geocoded<br>`;
                }
            }
            
            statusHTML += `</div>`;
            
            if (data.parsedListings && data.parsedListings.length > 0) {
                statusHTML += renderListingsTable(data.parsedListings);
            }
            
            container.innerHTML = statusHTML;
        }

        // Render listings table
        function renderListingsTable(listings) {
            console.log('üè† renderListingsTable called with:', listings);
            console.log('üè† Number of listings to render:', listings ? listings.length : 'undefined');
            
            const container = document.getElementById('listingContainer');
            console.log('üè† Container element found:', container);
            
            let statusHTML = `
                <h2>üìã Tax Sale Properties</h2>
                <div class="table-controls">
                    <div>
                        <strong>Sort by:</strong>
                        <select onchange="changeSort(this.value)" style="margin-left: 10px; padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="address" ${currentSort === 'address' ? 'selected' : ''}>Address</option>
                            <option value="amount" ${currentSort === 'amount' ? 'selected' : ''}>Amount Due (High to Low)</option>
                            <option value="parcelId" ${currentSort === 'parcelId' ? 'selected' : ''}>Parcel ID</option>
                            <option value="zipCode" ${currentSort === 'zipCode' ? 'selected' : ''}>Zip Code</option>
                        </select>
                    </div>
                    <div>
                        <strong>${listings.length}</strong> properties found
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="listing-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable('address')">Address üìç</th>
                                <th onclick="sortTable('parcelId')">Parcel ID üè∑Ô∏è</th>
                                <th onclick="sortTable('zipCode')">Zip Code üìÆ</th>
                                <th onclick="sortTable('amount')" title="Amount information not available from PDF. Contact Chatham County Tax Commissioner directly.">Amount Due üí∞*</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const sortedListings = sortListings(listings, currentSort);
            
            sortedListings.forEach((listing, index) => {


                const locationIcon = (listing.latitude && listing.longitude) ? 'ÔøΩ' : '‚ùì';
                const amount = listing.taxAmount || listing.bidAmount || 'N/A';
                
                statusHTML += `
                    <tr>
                        <td>${listing.address || 'N/A'}</td>
                        <td><strong>${listing.parcelId || 'N/A'}</strong></td>
                        <td><strong>${listing.zipCode || 'N/A'}</strong></td>
                        <td class="amount-cell"><strong>${amount}</strong></td>
                        <td class="location-cell">
                            ${listing.address ? 
                                `<button class="btn-small btn-primary" onclick="viewOnMapByAddress('${listing.address.replace(/'/g, "\\'")}')">View on Map</button>` : 
                                '<span style="color: #999; font-size: 0.8rem;">No address</span>'}
                        </td>
                    </tr>
                `;
            });
            
            statusHTML += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; border-radius: 8px;">
                    <p style="margin: 0; font-size: 14px; color: #856404;">
                        <strong>* Amount Due Notice:</strong> Tax amount information is not available in the digital format. 
                        Please contact the <a href="https://www.chathamcountyga.gov/departments/finance/tax-commissioner" target="_blank" style="color: #667eea;">Chatham County Tax Commissioner</a> 
                        directly for exact amount due information.
                    </p>
                </div>
            `;
            
            console.log('üè† Returning table HTML, length:', statusHTML.length);
            return statusHTML;
        }

        // Sorting functions
        function sortListings(listings, sortBy) {
            return [...listings].sort((a, b) => {
                switch (sortBy) {
                    case 'amount':
                        // Extract numeric value from amount fields
                        const aAmount = parseFloat(a.taxAmount || a.bidAmount || 0);
                        const bAmount = parseFloat(b.taxAmount || b.bidAmount || 0);
                        return bAmount - aAmount;
                    case 'parcelId':
                        return (a.parcelId || '').localeCompare(b.parcelId || '');
                    case 'zipCode':
                        return (a.zipCode || '').localeCompare(b.zipCode || '');
                    default:
                        return (a.address || '').localeCompare(b.address || '');
                }
            });
        }

        function changeSort(sortBy) {
            currentSort = sortBy;
            if (currentData && currentData.parsedListings) {
                displayResults(currentData);
            }
        }

        function sortTable(column) {
            changeSort(column);
        }

        // Map functions
        function toggleMap() {
            const mapContainer = document.getElementById('mapContainer');
            const showMapBtn = document.getElementById('showMapBtn');
            
            if (mapContainer.classList.contains('hidden')) {
                mapContainer.classList.remove('hidden');
                showMapBtn.textContent = 'üìç Hide Map';
                initializeMap();
                
                // Add markers if we have geocoded data
                if (currentData && currentData.parsedListings) {
                    addMarkersToMap(currentData.parsedListings);
                }
                
                // Scroll to map
                mapContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                mapContainer.classList.add('hidden');
                showMapBtn.textContent = 'üìç Show Properties on Map';
            }
        }

        function fitMapToProperties() {
            if (!map) {
                console.log('Map not initialized');
                return;
            }
            
            if (markers.length === 0) {
                console.log('No markers to fit to');
                showNotification('‚ö†Ô∏è No properties plotted on map yet');
                return;
            }
            
            console.log(`üéØ Fitting map to ${markers.length} property markers`);
            
            // Create a feature group from all markers
            const group = new L.featureGroup(markers);
            
            // Fit the map bounds to include all markers with padding
            map.fitBounds(group.getBounds().pad(0.1));
            
            showNotification(`üéØ Map fitted to ${markers.length} properties`);
        }

        async function showPropertiesOnMap(listings) {
            showNotification('üó∫Ô∏è Mapping properties... This may take a moment.');
            await addMarkersToMap(listings);
        }

        async function addMarkersToMap(listings) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            console.log('üó∫Ô∏è Adding markers for', listings.length, 'listings...');
            
            // Debug: Check coordinate data structure for first few listings
            console.log('üîç Debugging coordinate data structure:');
            listings.slice(0, 5).forEach((listing, i) => {
                console.log(`  Property ${i + 1}: ${listing.address}`);
                console.log(`    coordinates:`, listing.coordinates);
                console.log(`    latitude:`, listing.latitude);
                console.log(`    longitude:`, listing.longitude);
                console.log(`    lat:`, listing.lat);
                console.log(`    lng:`, listing.lng);
                console.log(`    lon:`, listing.lon);
                console.log('    ---');
            });
            
            // Show progress bar
            showProgress('Plotting Properties on Map', listings.length);
            
            let successfulCount = 0;
            let processedCount = 0;
            let coordinateFieldCounts = {
                'coordinates.lat/.lng': 0,
                'latitude/longitude': 0,
                'lat/lng': 0,
                'lat/lon': 0,
                'none': 0
            };
            
            // Process markers with a small delay to allow UI updates
            function processNextMarker(index) {
                if (index >= listings.length) {
                    // All markers processed
                    console.log(`‚úÖ Added ${successfulCount} markers to map out of ${listings.length} total properties`);
                    console.log('üìä Coordinate field distribution:', coordinateFieldCounts);
                    
                    // Fit map to show all markers if we have any
                    if (markers.length > 0) {
                        const group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                    
                    // Update progress to completion
                    updateProgress(listings.length, listings.length, `Completed! ${successfulCount} properties plotted on map`);
                    hideProgress(2000);
                    return;
                }
                
                const listing = listings[index];
                processedCount++;
                
                let lat = null;
                let lng = null;
                let coordinateSource = '';
                
                // Check multiple possible coordinate formats
                if (listing.coordinates && listing.coordinates.lat && listing.coordinates.lng) {
                    lat = listing.coordinates.lat;
                    lng = listing.coordinates.lng;
                    coordinateSource = 'coordinates.lat/.lng';
                    coordinateFieldCounts['coordinates.lat/.lng']++;
                } else if (listing.latitude && listing.longitude) {
                    lat = listing.latitude;
                    lng = listing.longitude;
                    coordinateSource = 'latitude/longitude';
                    coordinateFieldCounts['latitude/longitude']++;
                } else if (listing.lat && listing.lng) {
                    lat = listing.lat;
                    lng = listing.lng;
                    coordinateSource = 'lat/lng';
                    coordinateFieldCounts['lat/lng']++;
                } else if (listing.lat && listing.lon) {
                    lat = listing.lat;
                    lng = listing.lon;
                    coordinateSource = 'lat/lon';
                    coordinateFieldCounts['lat/lon']++;
                } else {
                    coordinateFieldCounts['none']++;
                }
                
                if (lat && lng) {
                    // Validate coordinates are reasonable (rough Georgia bounds)
                    if (lat >= 30.0 && lat <= 35.0 && lng >= -85.0 && lng <= -80.0) {
                        console.log(`‚úÖ Adding marker for ${listing.address} (${coordinateSource}): ${lat}, ${lng}`);
                        
                        const marker = L.marker([lat, lng])
                            .addTo(map)
                            .on('click', function() {
                                openPropertyModal(listing);
                            });
                        
                        markers.push(marker);
                        successfulCount++;
                        
                        // Update progress
                        updateProgress(processedCount, listings.length, `Added marker for ${listing.address}`);
                    } else {
                        console.log('‚ùå Invalid coordinates for', listing.address, ':', lat, lng);
                        updateProgress(processedCount, listings.length, `Skipped ${listing.address} (invalid coordinates)`);
                    }
                } else if (listing.address) {
                    // No coordinates available yet - could be geocoded individually if needed
                    console.log('‚ö†Ô∏è No coordinates available for:', listing.address);
                    updateProgress(processedCount, listings.length, `Skipped ${listing.address} (no coordinates)`);
                } else {
                    updateProgress(processedCount, listings.length, `Skipped property ${index + 1} (no address)`);
                }
                
                // Process next marker with a small delay for UI responsiveness
                setTimeout(() => processNextMarker(index + 1), 20);
            }
            
            // Start processing
            processNextMarker(0);
        }

        // Helper function to try multiple geocoding strategies using server proxy
        async function tryGeocoding(address) {
            console.log(`üîç Starting geocoding for: "${address}"`);
            
            try {
                // Use server-side proxy to avoid CORS issues
                const response = await fetch(`${API_BASE}/api/geocode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ address: address })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`   Response from server:`, data);
                
                if (data.success && data.results && data.results.length > 0) {
                    const result = data.results[0];
                    console.log(`   ‚úÖ Found result: ${result.lat}, ${result.lon}`);
                    console.log(`   Display name: ${result.display_name}`);
                    console.log(`   Strategy used: ${data.strategy || 'server-side'}`);
                    return data.results;
                } else {
                    console.log(`   ‚ùå No results found for: "${address}"`);
                    console.log(`   Error: ${data.error || 'Unknown error'}`);
                    return null;
                }
            } catch (error) {
                console.log(`   ‚ùå Error geocoding "${address}":`, error.message);
                
                // Fallback to direct API call (will likely fail due to CORS but worth trying)
                console.log(`   Attempting fallback direct API call...`);
                try {
                    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Georgia, USA')}&limit=1&addressdetails=1&countrycodes=us`;
                    const response = await fetch(geocodeUrl);
                    const results = await response.json();
                    
                    if (results && results.length > 0) {
                        console.log(`   ‚úÖ Fallback successful: ${results[0].lat}, ${results[0].lon}`);
                        return results;
                    }
                } catch (fallbackError) {
                    console.log(`   ‚ùå Fallback also failed:`, fallbackError.message);
                }
                
                return null;
            }
        }

        function viewOnMap(lat, lng) {
            // Show map if hidden
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer.classList.contains('hidden')) {
                toggleMap();
            }
            
            // Center map on the location
            setTimeout(() => {
                map.setView([lat, lng], 16);
            }, 500);
        }

        async function viewOnMapByAddress(address) {
            // Show map if hidden
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer.classList.contains('hidden')) {
                toggleMap();
            }
            
            // Show loading notification
            showNotification('üîç Finding location...');
            
            // Geocode address and center map
            setTimeout(async () => {
                try {
                    console.log('Geocoding address for map view:', address);
                    
                    const results = await tryGeocoding(address);
                    
                    if (results && results.length > 0) {
                        const lat = parseFloat(results[0].lat);
                        const lng = parseFloat(results[0].lon);
                        
                        console.log('Found coordinates:', lat, lng, 'for address:', address);
                        
                        map.setView([lat, lng], 17);
                        
                        // Add a temporary marker to highlight the location
                        const tempMarker = L.marker([lat, lng])
                            .bindPopup(`
                                <div style="text-align: center;">
                                    <h4 style="color: #667eea; margin-bottom: 10px;">üìç ${address}</h4>
                                    <p style="margin: 5px 0; font-size: 12px; color: #666;">Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                                    <button onclick="openGoogleStreetViewByAddress('${address.replace(/'/g, "\\'")}')" style="background: #f093fb; color: white; border: none; padding: 5px 10px; border-radius: 5px; margin: 2px;">üìç Street View</button>
                                </div>
                            `)
                            .addTo(map)
                            .openPopup();
                        
                        showNotification('‚úÖ Location found!');
                        
                        // Remove temporary marker after 8 seconds
                        setTimeout(() => {
                            map.removeLayer(tempMarker);
                        }, 8000);
                    } else {
                        console.log('No geocoding results for:', address);
                        showNotification('‚ùå Could not find location for: ' + address);
                    }
                } catch (error) {
                    console.error('Error geocoding address:', error);
                    showNotification('‚ùå Error finding location for: ' + address);
                }
            }, 500);
        }

        // Photo and Street View functions
        function viewPhoto(photoUrl) {
            window.open(photoUrl, '_blank');
        }

        function viewPhotoByParcelId(parcelId) {
            const listing = currentData.parsedListings.find(l => l.parcelId === parcelId);
            if (listing && listing.hasPhotos && listing.photoData && currentData.photoListUrl) {
                // Open the PDF at the appropriate page
                const pageNum = listing.photoData.estimatedPage || 1;
                const pdfUrl = `${currentData.photoListUrl}#page=${pageNum}`;
                window.open(pdfUrl, '_blank');
            } else {
                alert('Photo not available for this property.');
            }
        }

        function viewPhotoInPDF(index) {
            const listing = currentData.parsedListings[index];
            if (listing.hasPhotos && listing.photoData && currentData.photoListUrl) {
                // Open the PDF at the appropriate page
                const pageNum = listing.photoData.estimatedPage || 1;
                const pdfUrl = `${currentData.photoListUrl}#page=${pageNum}`;
                window.open(pdfUrl, '_blank');
            } else {
                alert('Photo not available for this property.');
            }
        }

        // Google Maps helper functions
        function openGoogleStreetView(lat, lng) {
            if (lat && lng) {
                // Use Google Maps with place marker - users can then click Street View
                const streetViewUrl = `https://www.google.com/maps/place/${lat},${lng}/@${lat},${lng},18z`;
                console.log('Opening Street View for coordinates:', lat, lng);
                console.log('Street View URL:', streetViewUrl);
                
                const newWindow = window.open(streetViewUrl, '_blank');
                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    alert('Pop-up blocked. Please allow pop-ups for this site and try again.');
                }
            } else {
                alert('Coordinates not available for this property.');
            }
        }

        function openGoogleStreetViewByAddress(address) {
            if (address) {
                // Use address for more accurate Street View
                const streetViewUrl = `https://www.google.com/maps/search/${encodeURIComponent(address + ', Georgia')}`;
                console.log('Opening Street View for address:', address);
                console.log('Street View URL:', streetViewUrl);
                
                const newWindow = window.open(streetViewUrl, '_blank');
                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    alert('Pop-up blocked. Please allow pop-ups for this site and try again.');
                }
            } else {
                alert('Address not available for this property.');
            }
        }

        function openGoogleMaps(lat, lng) {
            if (lat && lng) {
                const mapsUrl = `https://www.google.com/maps/place/${lat},${lng}`;
                console.log('Opening Google Maps:', mapsUrl);
                window.open(mapsUrl, '_blank');
            } else {
                alert('Coordinates not available for this property.');
            }
        }

        function openGoogleMapsByAddress(address) {
            if (address) {
                const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(address + ', Georgia')}`;
                console.log('Opening Google Maps for address:', address);
                window.open(mapsUrl, '_blank');
            } else {
                alert('Address not available for this property.');
            }
        }

        // Street View modal function (legacy)
        function openStreetView(lat, lng) {
            const streetViewContent = document.getElementById('streetViewContent');
            streetViewContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #667eea;">üìç Street View</h3>
                <div style="text-align: center; padding: 40px;">
                    <p style="margin-bottom: 20px; color: #666;">Click the button below to view this location in Google Street View:</p>
                    <a href="https://www.google.com/maps/@${lat},${lng},3a,75y,90t/data=!3m6!1e1" target="_blank" 
                       style="display: inline-block; background: #667eea; color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; margin: 10px;">
                        üåç Open Google Street View
                    </a>
                    <br>
                    <a href="https://www.google.com/maps/search/${lat},${lng}" target="_blank" 
                       style="display: inline-block; background: #f093fb; color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; margin: 10px;">
                        ÔøΩÔ∏è Open in Google Maps
                    </a>
                </div>
            `;
            document.getElementById('streetViewModal').classList.remove('hidden');
        }

        function closeStreetView() {
            document.getElementById('streetViewModal').classList.add('hidden');
        }

        // Property Details Modal Functions
        function openPropertyModal(property) {
            const propertyContent = document.getElementById('propertyModalContent');
            const amount = property.taxAmount || property.bidAmount || 'N/A';
            const coordinates = property.coordinates || {};
            
            // Create Street View URL for iframe
            let streetViewHtml = '';
            if (coordinates.lat && coordinates.lng) {
                const fallbackUrl = `https://maps.google.com/maps?q=${coordinates.lat},${coordinates.lng}&layer=c&cbll=${coordinates.lat},${coordinates.lng}&cbp=11,0,0,0,0&output=embed`;
                
                streetViewHtml = `
                    <div class="property-street-view">
                        <iframe src="${fallbackUrl}" 
                                loading="lazy"
                                allowfullscreen
                                referrerpolicy="no-referrer-when-downgrade"
                                title="Street View of ${property.address}">
                        </iframe>
                    </div>
                `;
            } else if (property.address) {
                const encodedAddress = encodeURIComponent(property.address + ', Georgia, USA');
                const fallbackUrl = `https://maps.google.com/maps?q=${encodedAddress}&layer=c&output=embed`;
                
                streetViewHtml = `
                    <div class="property-street-view">
                        <iframe src="${fallbackUrl}" 
                                loading="lazy"
                                allowfullscreen
                                referrerpolicy="no-referrer-when-downgrade"
                                title="Street View of ${property.address}">
                        </iframe>
                    </div>
                `;
            }
            
            propertyContent.innerHTML = `
                <div>
                    <h2 class="property-modal-header">
                        üè† ${property.address}
                    </h2>
                    
                    ${streetViewHtml}
                    
                    <div class="property-info-card">
                        <div class="property-details-grid">
                            <div class="property-detail-item">
                                <span class="property-detail-label">Amount Due:</span>
                                <span class="property-detail-value property-amount">${amount}</span>
                            </div>
                            <div class="property-detail-item">
                                <span class="property-detail-label">Parcel ID:</span>
                                <span class="property-detail-value">${property.parcelId || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('propertyModal').classList.remove('hidden');
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.add('hidden');
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            const streetViewModal = document.getElementById('streetViewModal');
            const propertyModal = document.getElementById('propertyModal');
            
            if (event.target === streetViewModal) {
                closeStreetView();
            }
            if (event.target === propertyModal) {
                closePropertyModal();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const streetViewModal = document.getElementById('streetViewModal');
                const propertyModal = document.getElementById('propertyModal');
                
                if (!streetViewModal.classList.contains('hidden')) {
                    closeStreetView();
                } else if (!propertyModal.classList.contains('hidden')) {
                    closePropertyModal();
                }
            }
        });

        // Progress Bar Functions
        function showProgress(title = 'Plotting Properties on Map', total = 0) {
            const container = document.getElementById('progressContainer');
            const titleElement = document.getElementById('progressTitle');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressCurrent = document.getElementById('progressCurrent');
            const progressTotal = document.getElementById('progressTotal');
            
            titleElement.textContent = title;
            progressFill.style.width = '0%';
            progressText.textContent = 'Starting...';
            progressCurrent.textContent = '0';
            progressTotal.textContent = total.toString();
            
            container.classList.add('show');
        }

        function updateProgress(current, total, message = '') {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressCurrent = document.getElementById('progressCurrent');
            
            const percentage = total > 0 ? (current / total) * 100 : 0;
            progressFill.style.width = percentage + '%';
            progressCurrent.textContent = current.toString();
            
            if (message) {
                progressText.textContent = message;
            } else {
                progressText.textContent = `Processing ${current} of ${total} properties`;
            }
        }

        function hideProgress(delay = 1500) {
            setTimeout(() => {
                const container = document.getElementById('progressContainer');
                container.classList.remove('show');
            }, delay);
        }

        // Geocoding functions
        async function geocodeProperties() {
            if (!currentData || !currentData.parsedListings) {
                alert('Please load listings first');
                return;
            }
            
            const geocodeBtn = document.getElementById('geocodeBtn');
            geocodeBtn.textContent = 'üîÑ Geocoding...';
            geocodeBtn.disabled = true;
            
            try {
                // Extract addresses from listings
                const addresses = currentData.parsedListings
                    .map(listing => listing.address)
                    .filter(address => address && address.trim().length > 0);
                
                if (addresses.length === 0) {
                    throw new Error('No valid addresses found to geocode');
                }
                
                console.log(`Starting batch geocoding for ${addresses.length} addresses`);
                
                // Show progress for geocoding
                showProgress('Geocoding Addresses', addresses.length);
                updateProgress(0, addresses.length, 'Starting batch geocoding...');
                
                const response = await fetch(`${API_BASE}/api/geocode-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ addresses: addresses })
                });
                
                if (response.ok) {
                    updateProgress(addresses.length, addresses.length, 'Processing geocoding results...');
                    
                    const geocodedData = await response.json();
                    console.log('Geocoding response:', geocodedData);
                    
                    // Update listings with geocoded coordinates
                    const addressToCoordinates = {};
                    geocodedData.results.forEach(result => {
                        if (result.success && result.coordinates) {
                            addressToCoordinates[result.address] = result.coordinates;
                        }
                    });
                    
                    // Apply coordinates to listings
                    currentData.parsedListings.forEach(listing => {
                        if (listing.address && addressToCoordinates[listing.address]) {
                            listing.coordinates = addressToCoordinates[listing.address];
                        }
                    });
                    
                    displayResults(currentData);
                    
                    // Update map if visible
                    if (!document.getElementById('mapContainer').classList.contains('hidden')) {
                        addMarkersToMap(currentData.parsedListings);
                    }
                    
                    const successCount = geocodedData.results.filter(r => r.success).length;
                    
                    // Update progress to completion
                    updateProgress(addresses.length, addresses.length, `Geocoding complete! ${successCount}/${addresses.length} properties located`);
                    hideProgress(2000);
                    
                    showNotification(`‚úÖ Geocoded ${successCount}/${addresses.length} properties`);
                } else {
                    const errorText = await response.text();
                    console.error('Geocoding failed:', response.status, errorText);
                    hideProgress(0);
                    throw new Error(`Geocoding failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Error geocoding:', error);
                hideProgress(0);
                showNotification(`‚ùå Geocoding failed: ${error.message}`);
            } finally {
                geocodeBtn.textContent = 'üîç Find Property Locations';
                geocodeBtn.disabled = false;
            }
        }

        // Utility functions
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                z-index: 1001;
                font-weight: 500;
                max-width: 300px;
                font-size: 14px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Event listeners
        window.addEventListener('scroll', () => {
            const floatingBtn = document.querySelector('.floating-action');
            if (window.scrollY > 300) {
                floatingBtn.style.display = 'block';
            } else {
                floatingBtn.style.display = 'none';
            }
        });

        // Close modal when clicking outside
        document.getElementById('streetViewModal').addEventListener('click', (e) => {
            if (e.target.id === 'streetViewModal') {
                closeStreetView();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Show initial loading state
                const countySelect = document.getElementById('countySelect');
                countySelect.innerHTML = '<option value="">üîç Loading counties...</option>';
                
                // Load counties and set default
                await loadCounties();
                
                // Show success notification
                showNotification('üéâ Default county set and listings loaded!', 'success');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('‚ö†Ô∏è Loading failed. Please try refreshing the page.', 'warning');
            }
        });
    </script>
</body>
</html>
